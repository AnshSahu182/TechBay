# name: CD (Deploy to AWS EC2)

# on:
#   workflow_run:
#     workflows: ["CI"]
#     types:
#       - completed

# jobs:
#   deploy:
#     if: ${{ github.event.workflow_run.conclusion == 'success' }}
#     runs-on: ubuntu-latest

#     steps:
#       - name: Setup SSH
#         run: |
#           mkdir -p ~/.ssh
#           echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
#           chmod 600 ~/.ssh/id_rsa
#           ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

#       - name: Deploy application
#         run: |
#           ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
#             cd /home/ec2-user/TechBay
#             git pull origin main
#             source venv/bin/activate
#             pip install -r requirements.txt
#             sudo systemctl restart flaskapp
#           EOF

name: CD (Deploy to AWS EC2)

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  deploy:
    # Run only if CI succeeded AND branch is staging or main
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      (github.event.workflow_run.head_branch == 'staging' ||
       github.event.workflow_run.head_branch == 'main')

    runs-on: ubuntu-latest

    steps:
      - name: Set deployment target based on branch
        run: |
          if [[ "${{ github.event.workflow_run.head_branch }}" == "staging" ]]; then
            echo "ENV=staging" >> $GITHUB_ENV
            echo "EC2_HOST=${{ secrets.STAGING_EC2_HOST }}" >> $GITHUB_ENV
            echo "BRANCH=staging" >> $GITHUB_ENV
          elif [[ "${{ github.event.workflow_run.head_branch }}" == "main" ]]; then
            echo "ENV=prod" >> $GITHUB_ENV
            echo "EC2_HOST=${{ secrets.PROD_EC2_HOST }}" >> $GITHUB_ENV
            echo "BRANCH=main" >> $GITHUB_ENV
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

      - name: Deploy application
        run: |
          echo "Deploying to $ENV server ($EC2_HOST)"

          ssh ${{ secrets.EC2_USER }}@$EC2_HOST << EOF
            cd /home/ec2-user/TechBay
            git fetch origin
            git checkout $BRANCH
            git pull origin $BRANCH
            source venv/bin/activate
            pip install -r requirements.txt
            sudo systemctl restart flaskapp
          EOF
